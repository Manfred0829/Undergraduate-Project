# 筆記處理功能測試指南

本文件提供關於如何測試筆記處理功能的詳細說明。

## 功能說明

筆記處理功能允許用戶上傳手寫或印刷的筆記圖片，系統會自動：

1. 使用 EasyOCR 辨識出圖片中的文字區域
2. 將每個文字區域送到 OpenAI 進行文字辨識
3. 修復辨識出的文字（修正錯別字、標點符號等）
4. 從修復後的文字中提取重點
5. 為每個重點生成嵌入向量
6. 將結果保存到指定目錄

目前所有生成的筆記重點的 `Keypoint_id` 都設置為 -1，表示暫未與講義重點對應。

## 最新修復

### GUI線程錯誤修復 (2024-04-10)

修復了以下問題：
- 在非主線程中使用 matplotlib 繪圖導致的程序崩潰
- 錯誤信息：`NSWindow should only be instantiated on the main thread!`
- 修改方式：
  1. 從 EasyOCR_local.py 中移除了 matplotlib 相關顯示功能
  2. 改為僅返回標記後的圖像，不進行視窗顯示
  3. 提供了可選的圖像保存功能用於調試

### 獨立測試腳本

為確認修復有效，提供了獨立的測試腳本 `test_easyocr_fix.py`：
```bash
python test_easyocr_fix.py -i <圖片路徑>
```

## 測試方式

### 方式一：使用測試腳本

我們提供了一個專門的測試腳本 `app/test_note_processing.py`，可以直接測試筆記處理功能：

```bash
# 在專案根目錄執行
python -m app.test_note_processing -s <科目名稱> -i <筆記圖片路徑>
```

例如：

```bash
python -m app.test_note_processing -s 英文 -i ./testdata/notes/note1.jpg
```

測試腳本會：
- 檢查輸入檔案是否存在並支援
- 測試讀取圖片
- 執行筆記處理流程
- 檢查處理結果
- 顯示處理後的部分重點內容

### 方式二：使用網頁界面

1. 啟動應用伺服器：

```bash
python app.py
```

2. 打開瀏覽器，訪問 http://localhost:5000

3. 登入系統

4. 選擇或創建一個科目

5. 在側邊欄點擊「上傳筆記」

6. 選擇筆記圖片並上傳

   > 支援的格式：jpg, jpeg, png, pdf

7. 點擊「上傳」按鈕

8. 等待處理完成（將在後台進行）

9. 檢查上傳結果

## 測試資料

測試時建議使用：

1. 含有清晰文字的照片
2. 手寫筆記照片
3. 印刷筆記照片
4. 不同語言的筆記（如中文、英文）

## 檢查處理結果

處理後的結果會保存在：

```
app/data_server/<科目名稱>/notes/<文件名>.json
```

可以使用以下命令檢查結果：

```bash
cat app/data_server/<科目名稱>/notes/<文件名>.json
```

結果是一個 JSON 陣列，每個元素代表一個筆記重點，包含以下欄位：

- `Title`: 重點標題
- `Content`: 重點內容
- `Embedding`: 嵌入向量（用於相似度搜尋）
- `Keypoint_id`: 對應的講義重點 ID（目前全部為 -1）

## 排除故障

如果測試過程中遇到問題：

### 1. 圖片無法讀取

- 檢查圖片路徑是否正確
- 確認圖片格式是否支援（jpg, jpeg, png, pdf）
- 確認圖片檔案是否損壞

### 2. EasyOCR 問題

- 確認已正確安裝 EasyOCR
- 檢查是否有需要的語言模型
- 圖片質量問題可能導致文字區域識別失敗

### 3. OpenAI API 問題

- 檢查 API 密鑰是否設置正確
- 確認 API 配額是否足夠
- 網絡連接問題可能導致 API 請求失敗

### 4. 檔案存取問題

- 確認目標目錄具有寫入權限
- 檢查磁碟空間是否足夠

## 日誌分析

所有處理過程都會記錄在日誌中，可以通過以下方式查看：

1. 控制台輸出
2. 應用日誌文件（如已配置）

日誌包含處理的各個階段，可用於分析問題：

- 圖片讀取
- 文字區域識別
- OCR 文字辨識
- 文字修復
- 重點提取
- 嵌入向量生成
- 檔案儲存

## 性能考量

筆記處理可能較耗時，特別是：

- 圖片較大或較多
- 文字較複雜或較多
- 網絡連接不穩定（影響 API 呼叫）

在測試大量或大尺寸圖片時，請預留足夠時間。 